@model Kup1Gis.ViewModels.IndexViewModel
@{
    ViewData["Title"] = "Главная";
    string prefixProperty = "property_";
    string prefixIdProperty = "propertyId_";
}

<!--Types of notifications-->
<div aria-live="polite" aria-atomic="true" class="">
    <div class="toast-container position-absolute bottom-0 end-0 p-3">
        <div id="SuccessNotify" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div id="SuccessToastText" class="toast-body">
                    Текст уведомления.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>
            </div>
        </div>

        <div id="DangerNotify" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div id="DangerToastText" class="toast-body">
                    Текст уведомления.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>
            </div>
        </div>
    </div>
</div>

<!--Content-->
<div class="d-flex flex-grow-1">
    <div class="container-fluid d-flex">
        <div class="row flex-grow-1 d-flex align-items-stretch">
            <div class="col-3 bg-gray-500 overflow-auto" style="height: calc(100vh - var(--header-height))">
                <form id="createPointForm" class="card mt-2 p-2 text-start needs-validation" novalidate>
                    <h5 class="text-center">Создать точку наблюдения</h5>
                    <div class="text-start">
                        <div class="row g-2">
                            <div class="col-4">
                                <label for="kupId" class="form-label">Id</label>
                                <input name="Id" id="kupId" class="form-control" type="number" placeholder="№" aria-describedby="idHelp"/>
                            </div>
                            <div class="col-8">
                                <label for="kupName" class="form-label">Название</label>
                                <input name="Name" id="kupName" class="form-control" type="text" placeholder="№ т.н." required/>
                            </div>
                        </div>
                        <div id="idHelp" class="form-text mt-1">
                            Если не указать id (№), то добавится наблюдение к существующей точке по названию (№ т.н.).
                        </div>
                        <div class="mt-3 form-floating">
                            <textarea name="GeographicalReference" id="kupGeographicalReference" class="form-control" placeholder="Географическая привязка"></textarea>
                            <label for="kupGeographicalReference">Географическая привязка</label>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6 mt-0">
                                <label for="kupLatitude" class="form-label">Широта</label>
                                <input name="Coordinates.Latitude" id="kupLatitude" class="form-control" type="number" step="0.000001" placeholder="Широта" required/>
                                <div class="invalid-feedback">
                                    Поле обязательно<!--Todo: Сделать логику необзятельных параметров для добавления наблюдения-->
                                </div>
                            </div>
                            <div class="col-6 mt-0">
                                <label for="kupLongitude" class="form-label">Долгота</label>
                                <input name="Coordinates.Longitude" id="kupLongitude" class="form-control" type="number" step="0.000001" placeholder="Долгота" required/>
                                <div class="invalid-feedback">
                                    Поле обязательно
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6 mt-0 form-floating">
                                <input name="Coordinates.AbsMarkOfSea" id="kupAbsMarkOfSea" class="form-control" type="number" step="0.0001" placeholder="Абс. отм., м"/>
                                <label for="kupAbsMarkOfSea" class="form-label">Абс. отм., м</label>
                            </div>
                            <div class="col-6 mt-0 form-floating">
                                <input name="Coordinates.Esp" id="kupEksp" class="form-control" type="text" placeholder="Эксп.,°"/>
                                <label for="kupEksp" class="form-label">Эксп.,°</label>
                            </div>
                        </div>
                        <label class="form-label">Наблюдение:</label>
                        @foreach (var property in Model.Properties)
                        {
                            <div class="mt-3 form-floating">
                                <textarea name="@($"{prefixProperty}{property.Name}")" id="@($"{prefixIdProperty}{property.Name}")" class="form-control" 
                                    placeholder="@property.Name"></textarea>
                                <label for="@($"{prefixIdProperty}{property.Name}")">@property.Name</label>
                            </div>
                        }
                    </div>
                    <div class="mt-3">
                        <button id="createPointBtn" class="btn btn-primary" type="button" >Создать</button>
                    </div>
                </form>
            </div>
            <div class="text-center border col-7">
                <h1 class="display-4">Welcome</h1>
                <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
            </div>
            <div class="col-2 bg-gray-500 overflow-auto" style="height: calc(100vh - var(--header-height))">
                <div class="card mt-2 p-2 text-center">
                    <h5>Точки наблюдения</h5>
                    <form id="loadExcelForm" enctype="multipart/form-data">
                        <button type="button" class="btn btn-success" data-bs-toggle="collapse" data-bs-target=".multi-collapse"
                                aria-expanded="false" aria-controls="collapseInputExcelButton collapseInputExcelSymbol1 collapseInputExcelSymbol2">
                            <span class="collapse multi-collapse" id="collapseInputExcelSymbol1">▼</span>
                            Импорт (Excel)
                            <span class="collapse multi-collapse" id="collapseInputExcelSymbol2">▼</span>
                        </button>
                        <div class="collapse multi-collapse" id="collapseInputExcelButton">
                            <input id="excelFile" name="excelFile" class="form-control mt-2 btn-outline-success" type="file" required
                                   accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"/>
                            <button id="loadExcelButton" type="button" class="btn btn-success mt-2">Загрузить</button>
                        </div>
                    </form>
                    <button type="button" class="btn btn-outline-primary mt-2">Создать новую</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.getElementById("loadExcelButton").addEventListener("click", async function () {
        let form = document.getElementById("loadExcelForm");
        let data = new FormData(form);
        
        let result = await sendExcelFile(data);
        let responseText = await result.text();
        console.log(result.status + '\n' + result.statusText + '\n' + responseText);
        
        if (result.ok){
            sendNotify("Файл загружен: " + responseText);
        }else{
            sendNotify("Ошибка загрузки файла: " + responseText);
        }
    })
    
    document.getElementById("createPointBtn").addEventListener("click", async function () {
        let form = document.getElementById("createPointForm") ;

        if (form.checkValidity()) {
            let data = new FormData(form);
            for (let pair in data.entries().map(x => x)){
                if (pair[0].startsWith(@prefixProperty)){
                    let property = {
                        PropertyName: pair[0].slice(@prefixProperty.Length),
                        PropertyValue: pair[1].trim()
                    };
                    data.delete(pair[0]);
                    data.append(property.PropertyValue, property.PropertyValue);
                } else {
                    data.set(pair[0], pair[1].trim());
                }
            }
            let response = await sendNewKup(data);
            let responseText = await response.text();
            console.log(response.status + '\n' + response.statusText + '\n' + responseText);
            if (response.ok) {
                sendNotify("Наблюдение добавлено!");
            } else {
                sendNotify(response.status + '\n' + response.statusText, true);
            }
        } else {
            sendNotify('Заполните обязательные поля!', true);
        }

        form.classList.add("was-validated");
    });
    
    async function sendNewKup(kup){
        return await fetch("/Kup/Add", {
            method: "POST",
            body: kup
        });
    }
    
    async function sendExcelFile(excel){
        return await fetch("/Kup/ImportExcel/", {
            method: "POST",
            body: excel
        });
    }
    
    function sendNotify(text, error = false){
        document.getElementById(error ? 'DangerToastText' : 'SuccessToastText')
            .textContent = text ?? "Здесь должен был быть текст.";
        let toastBase = document.getElementById(error ? 'DangerNotify' : 'SuccessNotify');
        let toast = new bootstrap.Toast(toastBase);
        toast.show()
    }
</script>